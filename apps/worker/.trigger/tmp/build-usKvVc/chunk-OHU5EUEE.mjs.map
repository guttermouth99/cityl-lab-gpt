{
  "version": 3,
  "sources": ["../../../src/jobs/maintenance/detect-duplicates.ts"],
  "sourcesContent": ["import { db } from \"@baito/db\";\nimport { jobs } from \"@baito/db/schema\";\nimport { schedules } from \"@trigger.dev/sdk\";\nimport { and, eq, sql } from \"drizzle-orm\";\n\nexport const detectDuplicates = schedules.task({\n  id: \"detect-duplicates\",\n  // Run weekly on Sundays at 2 AM\n  cron: \"0 2 * * 0\",\n  run: async () => {\n    console.log(\"Starting duplicate detection\");\n\n    // Find jobs with duplicate content hashes\n    const duplicates = await db\n      .select({\n        contentHash: jobs.contentHash,\n        count: sql<number>`count(*)`,\n      })\n      .from(jobs)\n      .where(eq(jobs.status, \"active\"))\n      .groupBy(jobs.contentHash)\n      .having(sql`count(*) > 1`);\n\n    console.log(`Found ${duplicates.length} duplicate groups`);\n\n    let archived = 0;\n\n    for (const dup of duplicates) {\n      // Get all jobs with this content hash\n      const dupJobs = await db\n        .select()\n        .from(jobs)\n        .where(\n          and(eq(jobs.contentHash, dup.contentHash), eq(jobs.status, \"active\"))\n        )\n        .orderBy(jobs.createdAt);\n\n      // Keep the oldest, archive the rest\n      const [oldest, ...rest] = dupJobs;\n\n      for (const job of rest) {\n        await db\n          .update(jobs)\n          .set({ status: \"archived\", updatedAt: new Date() })\n          .where(eq(jobs.id, job.id));\n        archived++;\n      }\n    }\n\n    console.log(`Archived ${archived} duplicate jobs`);\n\n    return {\n      duplicateGroups: duplicates.length,\n      archived,\n    };\n  },\n});\n"],
  "mappings": ";;;;;;;;;;;;;;;;AAAA;AAKO,IAAM,mBAAmB,kBAAU,KAAK;AAAA,EAC7C,IAAI;AAAA;AAAA,EAEJ,MAAM;AAAA,EACN,KAAK,mCAAY;AACf,YAAQ,IAAI,8BAA8B;AAG1C,UAAM,aAAa,MAAM,GACtB,OAAO;AAAA,MACN,aAAa,KAAK;AAAA,MAClB,OAAO;AAAA,IACT,CAAC,EACA,KAAK,IAAI,EACT,MAAM,GAAG,KAAK,QAAQ,QAAQ,CAAC,EAC/B,QAAQ,KAAK,WAAW,EACxB,OAAO,iBAAiB;AAE3B,YAAQ,IAAI,SAAS,WAAW,MAAM,mBAAmB;AAEzD,QAAI,WAAW;AAEf,eAAW,OAAO,YAAY;AAE5B,YAAM,UAAU,MAAM,GACnB,OAAO,EACP,KAAK,IAAI,EACT;AAAA,QACC,IAAI,GAAG,KAAK,aAAa,IAAI,WAAW,GAAG,GAAG,KAAK,QAAQ,QAAQ,CAAC;AAAA,MACtE,EACC,QAAQ,KAAK,SAAS;AAGzB,YAAM,CAAC,QAAQ,GAAG,IAAI,IAAI;AAE1B,iBAAW,OAAO,MAAM;AACtB,cAAM,GACH,OAAO,IAAI,EACX,IAAI,EAAE,QAAQ,YAAY,WAAW,oBAAI,KAAK,EAAE,CAAC,EACjD,MAAM,GAAG,KAAK,IAAI,IAAI,EAAE,CAAC;AAC5B;AAAA,MACF;AAAA,IACF;AAEA,YAAQ,IAAI,YAAY,QAAQ,iBAAiB;AAEjD,WAAO;AAAA,MACL,iBAAiB,WAAW;AAAA,MAC5B;AAAA,IACF;AAAA,EACF,GA9CK;AA+CP,CAAC;",
  "names": []
}
