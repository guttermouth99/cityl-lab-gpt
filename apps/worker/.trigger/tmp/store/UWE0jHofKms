{
  "version": 3,
  "sources": ["../../../src/jobs/newsletter/daily-dispatch.ts"],
  "sourcesContent": ["import { getUserAlerts, getUsersForDailyAlerts } from \"@baito/db/queries\";\nimport { chunk } from \"@baito/shared\";\nimport { schedules } from \"@trigger.dev/sdk\";\nimport { sendBatchTask } from \"./send-batch\";\n\nexport const dailyDispatch = schedules.task({\n  id: \"daily-dispatch\",\n  // Run at 6 AM UTC every day\n  cron: \"0 6 * * *\",\n  run: async () => {\n    console.log(\"Starting daily newsletter dispatch\");\n\n    // Get all users with daily alerts enabled\n    const users = await getUsersForDailyAlerts();\n    console.log(`Found ${users.length} users for daily alerts`);\n\n    if (users.length === 0) {\n      return { usersProcessed: 0, batches: 0 };\n    }\n\n    // Get alerts for each user\n    const usersWithAlerts = await Promise.all(\n      users.map(async (user) => {\n        const alerts = await getUserAlerts(user.id);\n        return {\n          userId: user.id,\n          email: user.email,\n          name: user.name,\n          alerts: alerts.filter((a) => a.isActive),\n        };\n      })\n    );\n\n    // Filter users who have active alerts\n    const eligibleUsers = usersWithAlerts.filter((u) => u.alerts.length > 0);\n    console.log(`${eligibleUsers.length} users have active alerts`);\n\n    // Chunk into batches of 100 for sending\n    const batches = chunk(eligibleUsers, 100);\n    console.log(`Split into ${batches.length} batches`);\n\n    // Spawn batch sending tasks\n    const batchTasks = batches.map((batch, index) =>\n      sendBatchTask.trigger({\n        batchIndex: index,\n        users: batch,\n        type: \"daily\",\n      })\n    );\n\n    await Promise.all(batchTasks);\n\n    return {\n      usersProcessed: eligibleUsers.length,\n      batches: batches.length,\n    };\n  },\n});\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAKO,IAAM,gBAAgB,kBAAU,KAAK;AAAA,EAC1C,IAAI;AAAA;AAAA,EAEJ,MAAM;AAAA,EACN,KAAK,mCAAY;AACf,YAAQ,IAAI,oCAAoC;AAGhD,UAAM,QAAQ,MAAM,uBAAuB;AAC3C,YAAQ,IAAI,SAAS,MAAM,MAAM,yBAAyB;AAE1D,QAAI,MAAM,WAAW,GAAG;AACtB,aAAO,EAAE,gBAAgB,GAAG,SAAS,EAAE;AAAA,IACzC;AAGA,UAAM,kBAAkB,MAAM,QAAQ;AAAA,MACpC,MAAM,IAAI,OAAO,SAAS;AACxB,cAAM,SAAS,MAAM,cAAc,KAAK,EAAE;AAC1C,eAAO;AAAA,UACL,QAAQ,KAAK;AAAA,UACb,OAAO,KAAK;AAAA,UACZ,MAAM,KAAK;AAAA,UACX,QAAQ,OAAO,OAAO,CAAC,MAAM,EAAE,QAAQ;AAAA,QACzC;AAAA,MACF,CAAC;AAAA,IACH;AAGA,UAAM,gBAAgB,gBAAgB,OAAO,CAAC,MAAM,EAAE,OAAO,SAAS,CAAC;AACvE,YAAQ,IAAI,GAAG,cAAc,MAAM,2BAA2B;AAG9D,UAAM,UAAU,MAAM,eAAe,GAAG;AACxC,YAAQ,IAAI,cAAc,QAAQ,MAAM,UAAU;AAGlD,UAAM,aAAa,QAAQ;AAAA,MAAI,CAAC,OAAO,UACrC,cAAc,QAAQ;AAAA,QACpB,YAAY;AAAA,QACZ,OAAO;AAAA,QACP,MAAM;AAAA,MACR,CAAC;AAAA,IACH;AAEA,UAAM,QAAQ,IAAI,UAAU;AAE5B,WAAO;AAAA,MACL,gBAAgB,cAAc;AAAA,MAC9B,SAAS,QAAQ;AAAA,IACnB;AAAA,EACF,GA/CK;AAgDP,CAAC;",
  "names": []
}
