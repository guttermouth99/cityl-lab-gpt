{
  "version": 3,
  "sources": ["../../../src/jobs/feeds/process-feed-batch.ts"],
  "sourcesContent": ["import {\n  createJob,\n  createOrganization,\n  findDuplicateJob,\n  findOrMatchOrganization,\n} from \"@baito/db/queries\";\nimport { computeContentHashSync } from \"@baito/shared\";\nimport { task } from \"@trigger.dev/sdk\";\n\ninterface FeedJob {\n  externalId: string;\n  title: string;\n  description: string;\n  organizationName: string;\n  url: string;\n  location?: string;\n}\n\nexport const processFeedBatch = task({\n  id: \"process-feed-batch\",\n  retry: {\n    maxAttempts: 3,\n  },\n  run: async (payload: {\n    batchIndex: number;\n    jobs: FeedJob[];\n    source: string;\n  }) => {\n    const { batchIndex, jobs, source } = payload;\n    console.log(`Processing batch ${batchIndex} with ${jobs.length} jobs`);\n\n    let created = 0;\n    let skipped = 0;\n    let errors = 0;\n\n    for (const feedJob of jobs) {\n      try {\n        // Find or create organization\n        let org = await findOrMatchOrganization({\n          name: feedJob.organizationName,\n          url: feedJob.url,\n        });\n\n        if (!org) {\n          org = await createOrganization({\n            name: feedJob.organizationName,\n            url: feedJob.url,\n          });\n        }\n\n        // Check for duplicates\n        const contentHash = computeContentHashSync(\n          `${feedJob.title}|${feedJob.description}|${org.id}`\n        );\n\n        const duplicate = await findDuplicateJob(contentHash, org.id);\n        if (duplicate) {\n          skipped++;\n          continue;\n        }\n\n        // Create the job\n        await createJob({\n          organizationId: org.id,\n          title: feedJob.title,\n          description: feedJob.description,\n          externalId: feedJob.externalId,\n          source: source as any,\n          sourceFeed: source,\n        });\n\n        created++;\n      } catch (error) {\n        console.error(`Error processing job ${feedJob.externalId}:`, error);\n        errors++;\n      }\n    }\n\n    return {\n      batchIndex,\n      processed: jobs.length,\n      created,\n      skipped,\n      errors,\n    };\n  },\n});\n"],
  "mappings": ";;;;;;;;;;;;;;;;AAAA;AAkBO,IAAM,mBAAmB,KAAK;AAAA,EACnC,IAAI;AAAA,EACJ,OAAO;AAAA,IACL,aAAa;AAAA,EACf;AAAA,EACA,KAAK,8BAAO,YAIN;AACJ,UAAM,EAAE,YAAY,MAAM,OAAO,IAAI;AACrC,YAAQ,IAAI,oBAAoB,UAAU,SAAS,KAAK,MAAM,OAAO;AAErE,QAAI,UAAU;AACd,QAAI,UAAU;AACd,QAAI,SAAS;AAEb,eAAW,WAAW,MAAM;AAC1B,UAAI;AAEF,YAAI,MAAM,MAAM,wBAAwB;AAAA,UACtC,MAAM,QAAQ;AAAA,UACd,KAAK,QAAQ;AAAA,QACf,CAAC;AAED,YAAI,CAAC,KAAK;AACR,gBAAM,MAAM,mBAAmB;AAAA,YAC7B,MAAM,QAAQ;AAAA,YACd,KAAK,QAAQ;AAAA,UACf,CAAC;AAAA,QACH;AAGA,cAAM,cAAc;AAAA,UAClB,GAAG,QAAQ,KAAK,IAAI,QAAQ,WAAW,IAAI,IAAI,EAAE;AAAA,QACnD;AAEA,cAAM,YAAY,MAAM,iBAAiB,aAAa,IAAI,EAAE;AAC5D,YAAI,WAAW;AACb;AACA;AAAA,QACF;AAGA,cAAM,UAAU;AAAA,UACd,gBAAgB,IAAI;AAAA,UACpB,OAAO,QAAQ;AAAA,UACf,aAAa,QAAQ;AAAA,UACrB,YAAY,QAAQ;AAAA,UACpB;AAAA,UACA,YAAY;AAAA,QACd,CAAC;AAED;AAAA,MACF,SAAS,OAAO;AACd,gBAAQ,MAAM,wBAAwB,QAAQ,UAAU,KAAK,KAAK;AAClE;AAAA,MACF;AAAA,IACF;AAEA,WAAO;AAAA,MACL;AAAA,MACA,WAAW,KAAK;AAAA,MAChB;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF,GA9DK;AA+DP,CAAC;",
  "names": []
}
